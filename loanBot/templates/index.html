<style>

    .sliders {
        margin-top:2rem;
        margin-left:20%;
        margin-right:20%;
    }

    #loan-amount {
        position:relative;
        background: #00bbd3;
        height: 250px;
        margin:10px;
        float:left;
        margin-left:20%;
        margin-right:12.5%;
    }

    span#span {
        position:absolute;
        z-index: 100000;
        bottom:-4rem;
        width:150px;
        left:-2.6rem;
    }

    .noUi-base {
        background:white;
    }

    #loan-amount .noUi-connect {
        background:#00bbd3;
    }

    #num-loans {
        position:relative;
        background: #00bbd3;
        height: 250px;
        margin:10px;
        float: left;
        margin-left:12.5%;
        margin-right:12.5%;

    }

    #num-loans .noUi-connect {
        background:#00bbd3;
    }


    #risk-tolerance {
        position:relative;
        background: #00bbd3;
        height: 250px;
        margin:10px;
        float: left;
        margin-left:12.5%;
        margin-right:20%;

    }

    #risk-tolerance .noUi-connect {
        background:#00bbd3;
    }

    #bar_chart svg {
        margin-left:37%;
        margin-top:4rem;
        fill: #4caf50;
    }
    #bar_chart span {
        position:absolute;
        margin-left: 30%;
        font-size:2rem;
        color:gray;
        margin-top:4.3rem;
    }

</style>
<div id="bar_chart"><span class="roi-label">ROI</span></div>
<div class="sliders">
    <div id="loan-amount"><span id="span">Amount to Loan</span></div>
    <div id="num-loans"><span id="span">Number of Loans</span></div>
    <div id="risk-tolerance"><span id="span">Risk Tolerance</span></div>
</div>


<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="static/d3.slider.js"></script>
<script type="text/javascript" src="static/nouislider.min.js"></script>
<script type="text/javascript" src="static/wNumb.js"></script>
<script>

    // Initialize values:
    var loan_amount = 10000;
    var num_loans = 1;
    var risk = 50;
    var loan_pred = 10.0;

    // Draw the d3 thing~
    var chart = d3.select("#bar_chart")
                   .append("svg:svg")
                   .attr("width", 800)
                   .attr("height", 100);

     var chance_scale = d3.scale.linear()
                                .domain([0, 100])
                                .range([0, 800]);

     var bar = chart.append("g")
                    .attr("class", "bar")

       bar.append("svg:rect")
          .attr("id", "chancebar")
          .attr("class", "bar")
          .attr("width", chance_scale(loan_pred))
          .attr("height", 50);

     bar.append("text")
        .attr("id", "percent_text")
        .attr("dy", ".75em")
        .attr("y", 15)
        .attr("x", chance_scale(loan_pred-5))
        .attr("text-anchor", "middle")
        .attr("fill", "white")
        .attr("font-size", 20)
        .text( loan_pred.toFixed(1) + "%");

    <!-- FUNCTION TO GET PREDICTIONS AND START ALTERING D3 STUFFZ  -->
    function getAndDrawChance(loan_amount, threshold){

        var data = JSON.stringify({
            example: [loan_amount,threshold]
        });

        $.ajax({
            type: "POST",
            contentType: "application/json; charset=utf-8",
            url: "/lend/",
            dataType: "json",
            async: true,
            data: data,
            success: function (data) {
                // data is returned as a list of json objects
                // to access an element do data[i]['<field_name>']
                // console.log(data[0]['profit_loss']);
                // console.log(data.length)
                var avg_roi = 0;
                if (data.length > 0){
                    for (i = 0; i < data.length; i++) {
                        avg_roi += 100 * data[i]['profit_loss']/data[i]['funded_amount'];
                    }
                    avg_roi = avg_roi/data.length;
                    console.log("avg roi: ",avg_roi);
                    // var chance = 100 * data[i]["profit_loss"]/parseFloat(data[i]['funded_amount']);
                    // console.log(chance);
                    d3.select("#chancebar")
                    .attr("width", chance_scale(avg_roi*5));
                    d3.select("#percent_text")
                    .attr("x", chance_scale(avg_roi*5-5))
                    .text(avg_roi.toFixed(1) + "%");
                }
                else {
                    d3.select("#chancebar")
                    .attr("width", chance_scale(avg_roi*5));
                    d3.select("#percent_text")
                    .attr("x", chance_scale(avg_roi*5-5))
                    .text(avg_roi.toFixed(1) + "%");
                }
            },
                error: function (result) {
            }
        })
    }




    var loan_amnt_slider = document.getElementById('loan-amount');
    var loan_amnt_value = document.getElementById('loan_amount');
    noUiSlider.create(loan_amnt_slider, {
        start: 10000,
        connect:'lower',
        orientation:'vertical',
        direction:'rtl',
        tooltips: wNumb({ decimals: 1 }),
        step: 1,
        pips: {
    		mode: 'range',
    		density: 4
        },
        range: {
            'min': 1,
            'max': 35000
        },
        format: wNumb({
        decimals: 0
        })
    });

    var num_loans_slider = document.getElementById('num-loans');
    var num_loans_value = document.getElementById('num_loans');
    noUiSlider.create(num_loans_slider, {
        start: 1,
        connect:'lower',
        orientation:'vertical',
        direction:'rtl',
        tooltips: wNumb({ decimals: 1 }),
        step: 1,
        pips: {
            mode: 'values',
		    values: [1,2,3,4,5,6,7,8,9,10],
		    density: 8
	    },
        range: {
        'min': 1,
        'max': 10
        },
        format: wNumb({
        decimals: 0
        })
    });

    var risk_slider = document.getElementById('risk-tolerance');
    var risk_value = document.getElementById('risk');
    noUiSlider.create(risk_slider, {
        start: 50,
        connect:'lower',
        orientation:'vertical',
        direction:'rtl',
        tooltips: wNumb({ decimals: 1 }),
        step: 1,
        pips: {
            mode: 'range',
            density: 4
        },
        range: {
        'min': 1,
        'max': 100
        },
        format: wNumb({
        decimals: 0
        })
    });

    var amnt_handle = loan_amnt_slider.getElementsByClassName('noUi-handle');
    var num_loans_handle = num_loans_slider.getElementsByClassName('noUi-handle');
    var risk_handle = risk_slider.getElementsByClassName('noUi-handle');

    // Controls what happens when sliders are used
    loan_amnt_slider.noUiSlider.on('update',function(values, amnt_handle){
        loan_amount = parseFloat(values[amnt_handle]);
        getAndDrawChance(loan_amount,risk);
    });
    num_loans_slider.noUiSlider.on('update',function(values, num_loans_handle){
        num_loans = parseFloat(values[num_loans_handle]);
    });
    risk_slider.noUiSlider.on('update',function(values, risk_handle){
        risk = (1 - (parseFloat(values[risk_handle])/100));
        getAndDrawChance(loan_amount,risk);
    });

    getAndDrawChance(loan_amount,risk);



</script>
